# 子网掩码与 IP 地址的关系

> [参考原文](https://www.zhihu.com/question/29723388) > [进制转换](http://www.kqiqi.com/tools/Hex/) > [本机公网 IP](https://ip.51240.com/)

在 IPV4 协议中，IP 地址是 4 字节共 32 位的二进制数字，由于二进制表达过长且人们更习惯十进制的表达方式，所以在实际使用中，会使用点分十进制来表示，比如 10.10.10.10。

IP 地址代表了在互联网中的逻辑地址，与之相对的则有 MAC 地址（物理地址），一个传输中的 IP 包真正要到达的地方其实是 MAC 地址，这就需要有 IP 地址和 MAC 地址的映射关系。在 IPV4 中，是 ARP 协议负责映射关系，在 IPV6 中则是 NDP（Neighbor Discovery Protocol）。

互联网（公网）是由一个个网段组成的，处于不同网段的 IP 地址之间不能直接通讯，需要由网段的网关进行转发。这样的设计在大型的网络交际中优势尤为明显，因为路由表中只存储网段和网关信息而不是主机信息，大大简化了路由表，否则主机间的交际纵横交错，难以管控。

IP 地址有如下分类：

- A 类：1.0.0.0 ～ 127.255.255.255，默认网络掩码：255.0.0.0，保留 10.0.0.0 ～ 10.255.255.255，一般用于大型网络。
- B 类：128.0.0.0 ～ 191.255.255.255，默认网络掩码：255.255.0.0，保留 172.16.0.0 ～ 172.31.255.255，一般用于中等规模网络。
- C 类：192.0.0.0 ～ 223.255.255.255，默认网络掩码：255.255.255.0，保留 192.168.0.0 ～ 192.168.255.255，一般用于小型网络。
- D 类：224.0.0.0 ～ 239.255.255.255，一般用于多路广播用户。
- E 类：240.0.0.0 ～ 255.255.255.255

![](@images/network_ip_class.png)

IP 的网络号部分决定了这个 IP 地址属于哪个网段，主机号决定了在这个网段下的哪台主机。

> ⚠️ 主机位全 0 代表一个网段，主机位全 1 代表该网段的广播地址，之间的才表示该网段的有效主机地址

互联网产生之初 IANA(The Internet Assigned Numbers Authority，互联网数字分配机构)为企业或区域分配 IP 时并没有什么问题，但是随着互联网的迅速发展，出现了 IP 地址耗尽危机，因为按照 ABC 类别进行分发 IP 网段太过于粗糙，比如对于 B 类 IP 来说，一个网络号对应的主机号有 65536 个，假如一个企业只需要 1000 个主机号，那么为该企业分配的 B 类网段有很多主机地址都是浪费的。

因此在原本大网段的基础上又细分了子网，子网对应的掩码就称为子网掩码。

:::tip
掩码的意思是把二进制 IP 地址的网络号部分用 1 掩盖，主机号部分用 0 掩盖，最后通过二进制 IP 地址和掩码进行按位与计算得到该 IP 地址的网段。
:::

:::tip
[VLSM](https://www.xiaopeiqing.com/posts/913.html)（Variable Length Subnetwork Mask，可变长子网掩码）：该种记法下没有 ABCDE 的分类概念，但提供了更精确的网段分配功能。比如 192.168.1.0 ～ 192.168.1.255 网段可以表示为 192.168.1.0/24，10.10.10.0 ～ 10.10.10.127 网段可以表示为 10.10.10.0/25（CIDR 表示法），后面的 24 和 25 代表这个网段的子网掩码全 1 的二进制位数，也就是网络号位数。
:::

因为不同网段的两个 IP 之间不能直接进行通讯，所以可以分为三种通信情况：

1. 自己与自己通信
2. 与本网段其它主机通信
3. 与别的网段主机的通信

假设本机 IP 是 10.10.10.1，掩码是 255.255.255.0，表示为 10.10.20.1/24。

对于第一种情况，当 ping 10.10.10.1 时，计算机和自己的 IP 相比较，所以会发给自己，我们称之为精确匹配；

第二种情况，当 ping 10.10.10.2 时，计算机和自己的 IP 相比较，发现并不相等，则需要退而求其次，使用模糊匹配，用自己的掩码 255.255.255.0 与 10.10.10.2 做按位与，得到网段 10.10.10，这个和自己在一个网段（一个广播域），所以可以广播 ARP 得到对方的 MAC 地址，完成通信；

第三种情况，当 ping 8.8.8.8 时，计算机和自己的 IP 相比较，发现并不相等，则需要退而求其次，使用模糊匹配，用自己的掩码 255.255.255.0 与 8.8.8.8 做按位与，得到网段 8.8.8，和自己 10.10.10 不在一个网段，需要使用最模糊的匹配，一般会匹配 0.0.0.0/0，这个是最后的选择，一般指向所处网段的网关，然后广播 ARP 得到网关的 MAC 地址，完成通信。

总结来讲，子网掩码的作用是与 IP 地址一同（子网掩码不能单独使用）确定一个子网段范围，也就是在 ARP 广播阶段判断目标 IP 是否和自身处在同个网段。

- 192.168.1.1/30 能否连通 192.168.1.2 和 192.168.1.10？

先把 192.168.1.1/30 转换成二进制得 11000000 10101000 00000001 00000001，子网掩码为 11111111 11111111 11111111 11111100，两者进行按位与运算后得 11000000 10101000 00000001 00000000，即网段为 192.168.1.0，由于主机号占了 2 位，得该网段的广播地址为 192.168.1.3，所以只有 192.168.1.1 和 192.168.1.2 是同网段的有效主机地址。

- 10.10.10.0/24 和 10.10.10.1/24 代表含义的区别？

前者代表一个网段，后者代表一个 IP 地址。
