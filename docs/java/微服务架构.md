# 微服务架构

## 名词解释

- 分布式：不同模块部署在不同服务器上，解决网站高并发问题。
- 集群：多台服务器部署相同应用构成一个集群，通过负载均衡设备共同对外提供服务。
- 监控：微服务架构中组件繁多，在高并发分布式的场景下，故障经常是突然间就雪崩式爆发。所以必须建立完善的监控体系，尽可能发现故障的征兆。
- 日志分析：使用 ELK(Elasticsearch,Logstash,Kibana)进行日志分析排查问题。
- 网关：使用网关来对外部请求进行统一的引导。
- 注册中心：类比房屋租赁，租客直接寻找房东效率低下，房东事先把房屋信息注册到中介平台，租客就能更快速的寻找。
- 熔断：调用链路很长的情况下，可能会导致整条链路一直在等待下游响应。所以当多次访问一个服务失败时，应熔断，标记该服务已停止工作，直接返回错误，直至该服务恢复正常后再重新建立连接（偶尔发送健康检查）。
- 服务降级：当下游服务停止工作后，如果该服务并非核心业务，则上游服务应该降级，以保证核心业务不中断。比如网上超市下单界面有一个推荐商品凑单的功能，当推荐模块挂了后，下单功能不能一起挂掉，只需要暂时关闭推荐功能即可。
- 限流：一个服务挂掉后，上游服务或者用户一般会习惯性地重试访问，这导致一旦服务恢复正常，很可能因为瞬间网络流量过大又立刻挂掉。因此服务需要限流来自我保护。

## Java 架构的演变

### 单体架构

Web 应用程序发展的早期，大部分 web 工程师将所有的功能模块打包到一起并放在一个 web 容器中运行，所有功能模块使用同一个数据库。

特点：

1. 所有的功能集成在一个项目工程中。
2. 所有的功能打在一个 war 包部署到服务器。
3. 通过部署应用集群和数据库集群来提高系统的性能。

优点：

1. 项目架构简单，前期开发成本低，周期短，小型项目的首选。
2. 开发效率高，模块之间交互采用本地方法调用。
3. 容易部署，运维成本小，直接打包为一个完整的包，拷贝到 web 容器的某个目录下即可运行。
4. 容易测试：IDE 都是为开发单个应用设计的. 容易测试——在本地就可以启动完整的系统。

缺点：

1. 全部功能集成在一个工程中，对于大型项目不易开发. 扩展及维护。
2. 版本迭代速度逐渐变慢，修改一个地方就要将整个应用全部编译. 部署. 启动，开发及测试周期过长。
3. 无法按需伸缩，通过集群的方式来实现水平扩展，无法针对某业务按需伸缩。

### 按业务垂直拆分为多个单体架构

> 先按照 dao service controller 去给项目水平分层没有任何意义，这无益于代码的复用。可在业务垂直分层后进一步再按照 dao service controller 去给项目水平分层。

针对单体架构的不足，为了适应大型项目的开发需求，许多公司将一个单体系统按业务垂直拆分为若干系统，系统之间通过网络交互来完成用户的业务处理，每个系统可分开部署。

特点：

1. 按业务垂直拆分成一个一个的单体系统，此架构也称为垂直架构。
2. 系统与系统之间的存在数据冗余，耦合性较大，如上图中三个项目都存在客户信息。
3. 系统之间的接口多为实现数据同步，如上图中三个项目要同步客户信息。

优点：

1. 通过垂直拆分，每个子系统变成小型系统，功能简单，前期开发成本低，周期短。
2. 每个子系统可按需伸缩。
3. 每个子系统可采用不同的技术。

缺点：

1. 子系统之间存在数据冗余. 功能冗余，耦合性高。
2. 按需伸缩粒度不够，对同一个子系统中的不同的业务无法实现，比如订单管理和用户管理。

### SOA 架构

SOA 是一种面向服务的架构，它将不同业务功能按服务进行拆分，并通过这些服务之间定义良好的接口和协议联系起来。

特点：

1. 基于 SOA 的架构思想，将重复公用的功能抽取为组件，以服务的方式向各各系统提供服务。
2. 各各系统与服务之间采用 webservice. rpc 等方式进行通信。
3. ESB 企业服务总线作为系统与服务之间通信的桥梁。

优点：

1. 将重复的功能抽取为服务，提高开发效率，提高系统的可重用性. 可维护性。
2. 可以针对不同服务的特点按需伸缩。
3. 采用 ESB 减少系统中的接口耦合。

缺点：

1. 系统与服务的界限模糊，会导致抽取的服务的粒度过大，系统与服务之间耦合性高。
2. 虽然使用了 ESB，但是服务的接口协议不固定，种类繁多，不利于系统维护。

### 微服务架构

基于 SOA 架构的思想，为了满足移动互联网对大型项目及多客户端的需求，对服务层进行细粒度的拆分，所拆分的每个服务只完成某个特定的业务功能，比如订单服务只实现订单相关的业务，用户服务实现用户管理相关的业务等等，服务的粒度很小，所以称为微服务架构。

特点：

1. 服务层按业务拆分为一个一个的微服务。
2. 微服务的职责单一。
3. 微服务之间采用 RESTful. RPC 等轻量级协议传输。
4. 有利于采用前后端分离架构。

优点：

1. 服务拆分粒度更细，有利于资源重复利用，提高开发效率。
2. 可以更加精准的制定每个服务的优化方案，按需伸缩。
3. 适用于互联网时代，产品迭代周期更短。

缺点：

1. 开发的复杂性增加，因为一个业务流程需要多个微服务通过网络交互来完成。
2. 微服务过多，服务治理成本高，不利于系统维护。
3. Service 多了以后，Service 和 Service 之间的混乱调用。

## Spring Cloud

在微服务架构中包含服务注册中心、配置中心、消息总线、负载均衡、断路器、数据监控等环节，而 Spring Cloud 为我们提供了一套简易的编程模型，使我们能在 Spring Boot 的基础上轻松地实现微服务项目的构建。

架构图：

![](@images/spring_cloud_1.png)

![](@images/spring_cloud_2.png)

## 推荐文章

[一文详解微服务架构](https://www.cnblogs.com/skabyy/p/11396571.html)
[大型 JavaWeb 分布式系统中关于 maven 多模块构建以及代码依赖管理的疑问与痛点？](https://www.zhihu.com/question/37344673/answer/443752222)
[Spring Cloud 入门总结](https://zhuanlan.zhihu.com/p/95696180?from_voters_page=true)
